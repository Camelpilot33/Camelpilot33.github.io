<!DOCTYPE html>

<html lang="en">

<head>
    <link rel="icon" href="../../img/favicon.png">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="author" content="Samuel Sastry">
    <title>nbonacci</title>
    <!-- CSS -->
    <link href="../../css/style.css" rel="stylesheet" type="text/css" />
    <link href="../../css/navbarstyle.css" rel="stylesheet" type="text/css" />
    <link href="../../css/subpage.css" rel="stylesheet" type="text/css" />
    <!-- laTeX support -->
    <script async src="../../js/mjaxconfig.js"></script>
    <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
    <script src="https://tikzjax.com/v1/tikzjax.js"></script>
</head>

<body>
    <div class="topnav">
        <a class="activenav" href="../../">Home</a>
        <a href="../../#projects">Projects</a>
        <a href="../../#games">Games</a>
        <a href="../../#other">Other</a>
        <div class="right">
            <a onclick="history.back()">‚Üê</a>
            <a href="https://discord.com/users/701829178592591952D"><img height="25.5px" style="vertical-align: middle"
                    src="../../img/discord.svg"></a>
            <a
                href="https://mail.google.com/mail/?view=cm&fs=1&to=anonymouscamul@gmail.com&su=Subject&body=To:%20Samuel">
                <img height="25.5px" style="vertical-align: middle" src="../../img/gmail.svg">
            </a>
            <a href="https://github.com/Camelpilot33" target="_blank" rel="noopener noreferrer">
                <img height="25.5px" style="vertical-align: middle" src="../../img/github-mark-white.png"></img>
            </a>
        </div>
    </div>
    <br>
    <div class="content">
        <h1>Fast n-Bonacci Calculation</h1>
        <div class="page-text">
            <h3>The Problem</h3>
            <a href="https://en.wikipedia.org/wiki/Fibonacci_sequence" target="_blank">The Fibonacci sequence</a>
            (sequence <a href="https://oeis.org/A000045" target="_blank">A000045</a>) is a well-known sequence of
            numbers where each number is the sum of the two preceding: $F_n = F_{n-1} + F_{n-2}$. It has the initial
            conditions $F_0 = 0$ and $F_1 = 1$. The sequence starts $0, 1, 1, 2, 3, 5, 8, 13, 21, 34, \ldots$. A common
            introductory programming exercise is to write a function to calculate the $n$th Fibonacci number. This is
            usually done recursively:
            <pre
                class="code"><span class='sh-res'>int</span> <span class='sh-var'>fib</span><span class='sh-pun'>(</span><span class='sh-res'>int</span> <span class='sh-var'>n</span><span class='sh-pun'>)</span> <span class='sh-com'>// This function uses recursion and the standard formula</span><br><span class='sh-pun'>{</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>if</span> <span class='sh-pun'>(</span><span class='sh-var'>n</span> <span class='sh-op'><</span><span class='sh-op'>=</span> <span class='sh-num'>1</span><span class='sh-pun'>)</span><br>&emsp;&emsp;&emsp;<span class='sh-pun'>{</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class='sh-res'>return</span> <span class='sh-var'>n</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-pun'>}</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>return</span> <span class='sh-var'>fib</span><span class='sh-pun'>(</span><span class='sh-var'>n</span> <span class='sh-op'>-</span> <span class='sh-num'>1</span><span class='sh-pun'>)</span> <span class='sh-op'>+</span> <span class='sh-var'>fib</span><span class='sh-pun'>(</span><span class='sh-var'>n</span> <span class='sh-op'>-</span> <span class='sh-num'>2</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br><span class='sh-pun'>}</span>
            </pre>
            This function has a time complexity of $\mathcal O(2^n)$ and a space complexity of $\mathcal O(n)$, which is
            very inefficient. There are many redundant calculations, as the function calculates the same Fibonacci
            numbers multiple times, so by removing them we achieve a time complexity of $\mathcal O(n)$ and a space
            complexity of $\mathcal O(1)$:
            <pre
                class="code"><span class='sh-res'>int</span> <span class='sh-var'>fib</span><span class='sh-pun'>(</span><span class='sh-res'>int</span> <span class='sh-var'>n</span><span class='sh-pun'>)</span> <span class='sh-com'>// This function uses iteration and the formula $F_n = F_{n-1} + F_{n-2}$</span><br><span class='sh-pun'>{</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>int</span> <span class='sh-var'>a</span> <span class='sh-op'>=</span> <span class='sh-num'>0</span><span class='sh-pun'>,</span> <span class='sh-var'>b</span> <span class='sh-op'>=</span> <span class='sh-num'>1</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>for</span> <span class='sh-pun'>(</span><span class='sh-res'>int</span> <span class='sh-var'>i</span> <span class='sh-op'>=</span> <span class='sh-num'>0</span><span class='sh-pun'>;</span> <span class='sh-var'>i</span> <span class='sh-op'>&lt;</span> <span class='sh-var'>n</span><span class='sh-pun'>;</span> <span class='sh-var'>i</span><span class='sh-op'>++</span><span class='sh-pun'>)</span><br>&emsp;&emsp;&emsp;<span class='sh-pun'>{</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class='sh-res'>int</span> <span class='sh-var'>temp</span> <span class='sh-op'>=</span> <span class='sh-var'>a</span> <span class='sh-op'>+</span> <span class='sh-var'>b</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class='sh-var'>a</span> <span class='sh-op'>=</span> <span class='sh-var'>b</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<span class='sh-var'>b</span> <span class='sh-op'>=</span> <span class='sh-var'>temp</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-pun'>}</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>return</span> <span class='sh-var'>a</span><span class='sh-pun'>;</span><br><span class='sh-pun'>}</span>
            </pre>
            <br><h3>Explicit Formula</h3>
            Let v be a column vector and M be a 2x2 matrix:
            $$v(n) = \begin{bmatrix} F_{n} \\ F_{n+1} \end{bmatrix} \quad M = \begin{bmatrix} 0 & 1 \\ 1 & 1
            \end{bmatrix}$$
            Then the following relation holds:
            $$v(n)=M\cdot v(n-1)=M^n\cdot v(0)$$
            As $v(0) = \begin{bmatrix} 0 \\ 1 \end{bmatrix}$, we have:
            $$F_n = \begin{bmatrix} 1 & 0 \end{bmatrix} \cdot M^n \cdot \begin{bmatrix} 0 \\ 1 \end{bmatrix}$$
            This $M$ diagonalizes nicely, so we can write:
            $$\begin{align*}
            F_n&=\begin{bmatrix} 1 & 0 \end{bmatrix} \cdot (SDS^{-1})^n \cdot \begin{bmatrix} 0 \\ 1 \end{bmatrix}\\
            &=\begin{bmatrix} 1 & 0 \end{bmatrix} \cdot S \cdot D^n \cdot S^{-1} \cdot \begin{bmatrix} 0 \\ 1 \end{bmatrix}
            \end{align*}$$
            Using <a href="https://www.mathworks.com/products/matlab.html" target="_blank">MatLab</a>, we can solve for F_n:
            <pre
                class="code"><span class='sh-res'>syms</span> <span class='sh-var'>x</span> <span class='sh-var'>n</span> <span class='sh-var'>rt5</span> <span class='sh-var'>phi</span> <span class='sh-var'>psi</span><span class='sh-pun'>;</span> <span class='sh-com'>% Define symbolic variables</span><br><span class='sh-var'>A</span> <span class='sh-op'>=</span> <span class='sh-pun'>[</span><span class='sh-num'>0</span><span class='sh-pun'>,</span> <span class='sh-num'>1</span><span class='sh-pun'>;</span> <span class='sh-num'>1</span><span class='sh-pun'>,</span> <span class='sh-num'>1</span><span class='sh-pun'>]</span><span class='sh-pun'>;</span> <span class='sh-com'>% Define A</span><br><span class='sh-var'>char_poly</span> <span class='sh-op'>=</span> <span class='sh-res'>det</span><span class='sh-pun'>(</span><span class='sh-var'>x</span> <span class='sh-op'>*</span> <span class='sh-res'>eye</span><span class='sh-pun'>(</span><span class='sh-num'>2</span><span class='sh-pun'>)</span> <span class='sh-op'>-</span> <span class='sh-var'>A</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span> <span class='sh-com'>% Characteristic polynomial</span><br><span class='sh-com'>% Solve for D</span><br><span class='sh-var'>eigenvalues</span> <span class='sh-op'>=</span> <span class='sh-res'>solve</span><span class='sh-pun'>(</span><span class='sh-var'>char_poly</span> <span class='sh-op'>==</span> <span class='sh-num'>0</span><span class='sh-pun'>,</span> <span class='sh-var'>x</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br><span class='sh-var'>D</span> <span class='sh-op'>=</span> <span class='sh-res'>diag</span><span class='sh-pun'>(</span><span class='sh-var'>eigenvalues</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br><span class='sh-com'>% Solve for S</span><br><span class='sh-var'>eigenvectors</span> <span class='sh-op'>=</span> <span class='sh-pun'>[</span><span class='sh-pun'>]</span><span class='sh-pun'>;</span><br><span class='sh-res'>for</span> <span class='sh-var'>i</span> <span class='sh-op'>=</span> <span class='sh-num'>1</span><span class='sh-pun'>:</span><span class='sh-res'>length</span><span class='sh-pun'>(</span><span class='sh-var'>eigenvalues</span><span class='sh-pun'>)</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>lambda</span> <span class='sh-op'>=</span> <span class='sh-var'>eigenvalues</span><span class='sh-pun'>(</span><span class='sh-var'>i</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>eig_vec</span> <span class='sh-op'>=</span> <span class='sh-res'>null</span><span class='sh-pun'>(</span><span class='sh-var'>A</span> <span class='sh-op'>-</span> <span class='sh-var'>lambda</span> <span class='sh-op'>*</span> <span class='sh-res'>eye</span><span class='sh-pun'>(</span><span class='sh-num'>2</span><span class='sh-pun'>)</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>eig_vec</span> <span class='sh-op'>=</span> <span class='sh-var'>eig_vec</span> <span class='sh-op'>/</span> <span class='sh-res'>norm</span><span class='sh-pun'>(</span><span class='sh-var'>eig_vec</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>eigenvectors</span> <span class='sh-op'>=</span> <span class='sh-pun'>[</span><span class='sh-var'>eigenvectors</span><span class='sh-pun'>,</span> <span class='sh-var'>eig_vec</span><span class='sh-pun'>]</span><span class='sh-pun'>;</span><br><span class='sh-res'>end</span><br><span class='sh-var'>S</span> <span class='sh-op'>=</span> <span class='sh-var'>eigenvectors</span><span class='sh-pun'>;</span><br><span class='sh-var'>D_n</span> <span class='sh-op'>=</span> <span class='sh-var'>D</span><span class='sh-op'>^</span><span class='sh-var'>n</span><span class='sh-pun'>;</span><br><span class='sh-var'>vec</span> <span class='sh-op'>=</span> <span class='sh-pun'>[</span><span class='sh-num'>0</span><span class='sh-pun'>;</span> <span class='sh-num'>1</span><span class='sh-pun'>]</span><span class='sh-pun'>;</span><br><span class='sh-var'>result</span> <span class='sh-op'>=</span> <span class='sh-pun'>[</span><span class='sh-num'>1</span><span class='sh-pun'>,</span> <span class='sh-num'>0</span><span class='sh-pun'>]</span> <span class='sh-op'>*</span> <span class='sh-var'>S</span> <span class='sh-op'>*</span> <span class='sh-var'>D_n</span> <span class='sh-op'>*</span> <span class='sh-pun'>(</span><span class='sh-var'>S</span> <span class='sh-op'>\</span> <span class='sh-var'>vec</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br><span class='sh-var'>e</span><span class='sh-op'>=</span><span class='sh-res'>subs</span><span class='sh-pun'>(</span><span class='sh-res'>simplify</span><span class='sh-pun'>(</span><span class='sh-var'>result</span><span class='sh-pun'>)</span><span class='sh-pun'>,</span> <span class='sh-num'>5</span><span class='sh-op'>^(</span><span class='sh-num'>1</span><span class='sh-op'>/</span><span class='sh-num'>2</span><span class='sh-op'>)</span><span class='sh-pun'>,</span> <span class='sh-var'>rt5</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br><span class='sh-var'>e</span><span class='sh-op'>=</span><span class='sh-res'>subs</span><span class='sh-pun'>(</span><span class='sh-var'>e</span><span class='sh-pun'>,[</span><span class='sh-num'>5</span><span class='sh-op'>^(</span><span class='sh-num'>1</span><span class='sh-op'>/</span><span class='sh-num'>2</span><span class='sh-op'>),</span><span class='sh-var'>rt5</span><span class='sh-op'>/</span><span class='sh-num'>2</span><span class='sh-op'>+</span><span class='sh-num'>1</span><span class='sh-op'>/</span><span class='sh-num'>2</span><span class='sh-pun'>,</span><span class='sh-num'>1</span><span class='sh-op'>/</span><span class='sh-num'>2</span><span class='sh-op'>-</span><span class='sh-var'>rt5</span><span class='sh-op'>/</span><span class='sh-num'>2</span><span class='sh-pun'>,</span><span class='sh-var'>rt5</span><span class='sh-op'>/</span><span class='sh-num'>5</span><span class='sh-pun'>],[</span><span class='sh-var'>rt5</span><span class='sh-pun'>,</span><span class='sh-var'>phi</span><span class='sh-pun'>,</span><span class='sh-var'>psi</span><span class='sh-pun'>,</span><span class='sh-num'>1</span><span class='sh-op'>/</span><span class='sh-var'>rt5</span><span class='sh-pun'>])</span><span class='sh-pun'>;</span><br><span class='sh-res'>disp</span><span class='sh-pun'>(</span><span class='sh-var'>e</span><span class='sh-pun'>);</span><br><br>
                <samp>> (phi^n - psi^n)/rt5</samp>
            </pre>
            $$F_n = \frac{\phi^n - \psi^n}{\sqrt{5}}$$
            where $\phi = \frac{1 + \sqrt{5}}{2}$ and $\psi = \frac{1 - \sqrt{5}}{2}$. This formula gives us an explicit value for the $n$th Fibonacci number, however it quickly loses precision as $n$ grows.

            <br><br><h3>Exponentiation by Squaring</h3>
            From earlier, the only resource intensize operation was taking $M^n$. We can use the <a href="https://en.wikipedia.org/wiki/Exponentiation_by_squaring" target="_blank">Exponentiation by squaring</a> algorithm to reduce the number of multiplications. The algorithm is as follows (using my <a href="https://github.com/Camelpilot33/nbonacci/blob/main/matrix.c" target="_blank">matrix implementation</a>):
            <pre
                class="code"><span class='sh-res'>unsigned</span> <span class='sh-res'>long</span> <span class='sh-res'>long</span> <span class='sh-var'>fib</span><span class='sh-pun'>(</span><span class='sh-res'>int</span> <span class='sh-var'>n</span><span class='sh-pun'>)</span> <span class='sh-com'>// This function uses matrix exponentiation</span><br><span class='sh-pun'>{</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>Matrix</span> <span class='sh-op'>*</span><span class='sh-var'>m</span> <span class='sh-op'>=</span> <span class='sh-var'>create_matrix</span><span class='sh-pun'>(</span><span class='sh-num'>2</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span> <span class='sh-com'>// allocate a matrix</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>if</span> <span class='sh-pun'>(</span><span class='sh-var'>m</span> <span class='sh-op'>==</span> <span class='sh-res'>NULL</span><span class='sh-pun'>)</span> <span class='sh-res'>exit</span><span class='sh-pun'>(</span><span class='sh-num'>1</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>m</span><span class='sh-op'>-></span><span class='sh-var'>matrix</span><span class='sh-pun'>[</span><span class='sh-num'>0</span><span class='sh-pun'>]</span><span class='sh-pun'>[</span><span class='sh-num'>0</span><span class='sh-pun'>]</span> <span class='sh-op'>=</span> <span class='sh-num'>0</span><span class='sh-pun'>;</span> <span class='sh-com'>//set up values</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>m</span><span class='sh-op'>-></span><span class='sh-var'>matrix</span><span class='sh-pun'>[</span><span class='sh-num'>0</span><span class='sh-pun'>]</span><span class='sh-pun'>[</span><span class='sh-num'>1</span><span class='sh-pun'>]</span> <span class='sh-op'>=</span> <span class='sh-num'>1</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>m</span><span class='sh-op'>-></span><span class='sh-var'>matrix</span><span class='sh-pun'>[</span><span class='sh-num'>1</span><span class='sh-pun'>]</span><span class='sh-pun'>[</span><span class='sh-num'>0</span><span class='sh-pun'>]</span> <span class='sh-op'>=</span> <span class='sh-num'>1</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-var'>m</span><span class='sh-op'>-></span><span class='sh-var'>matrix</span><span class='sh-pun'>[</span><span class='sh-num'>1</span><span class='sh-pun'>]</span><span class='sh-pun'>[</span><span class='sh-num'>1</span><span class='sh-pun'>]</span> <span class='sh-op'>=</span> <span class='sh-num'>1</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>Matrix</span> <span class='sh-op'>*</span><span class='sh-var'>a</span> <span class='sh-op'>=</span> <span class='sh-var'>power_matrix</span><span class='sh-pun'>(</span><span class='sh-var'>m</span><span class='sh-pun'>,</span> <span class = 'sh-var' > n</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span> <span class='sh-com'>//take the matrix_power</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>if</span> <span class='sh-pun'>(</span><span class='sh-var'>a</span> <span class='sh-op'>==</span> <span class='sh-res'>NULL</span><span class='sh-pun'>)</span> <span class='sh-res'>return</span> <span class='sh-num'>1</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>res</span> <span class='sh-op'>=</span> <span class='sh-var'>a</span><span class='sh-op'>-></span><span class='sh-var'>matrix</span><span class='sh-pun'>[</span><span class='sh-num'>0</span><span class='sh-pun'>]</span><span class='sh-pun'>[</span><span class='sh-num'>1</span><span class='sh-pun'>]</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>if</span> <span class='sh-pun'>(</span><span class='sh-var'>m</span> <span class='sh-op'>!=</span> <span class='sh-var'>a</span><span class='sh-pun'>)</span> <span class='sh-res'>free_matrix</span><span class='sh-pun'>(</span><span class='sh-var'>a</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>free_matrix</span><span class='sh-pun'>(</span><span class='sh-var'>m</span><span class='sh-pun'>)</span><span class='sh-pun'>;</span><br>&emsp;&emsp;&emsp;<span class='sh-res'>return</span> <span class='sh-var'>res</span><span class='sh-pun'>;</span><br><span class='sh-pun'>}</span>
            </pre>
            This has a time complexity of $\mathcal O(\log n)$ and a space complexity of $\mathcal O(1)$, which is much more efficient than the previous methods. The matrix exponentiation method is also more accurate than the explicit formula method, as it does not rely on floating point arithmetic. The only issue is that when $n$ exceeds $93$, the result will overflow a 64-bit integer, so the result will be incorrect. This can be fixed by using a type that supports arbitrary precision arithmetic, such as <a href="https://gmplib.org/" target="_blank">GMP's</a> <code>mpz_t</code> type.
            
            <br><br><h3>n-Bonacci</h3>
            We can define the n-Bonnacci sequence as a sequence where each number is the sum of the n preceding numbers ($F_m = F_{m-1} + F_{m-2} + \ldots + F_{m-n}$). We can use the same matrix exponentiation method to calculate the nth n-Bonacci number. The matrix is defined as:
            $$M = \begin{bmatrix} 0 & 1 & 0 & \cdots & 0 \\ 0 & 0 & 1 & \cdots & 0 \\ \vdots & \vdots & \vdots & \ddots & \vdots \\ 0 & 0 & 0 & \ddots & 1\\ 1 & 1 & 1 & \cdots & 1 \end{bmatrix}$$
            The nth n-Bonacci number is then:
            $$F_n = \begin{bmatrix} 1 & 0 & 0 & \cdots & 0 \end{bmatrix} \cdot M^n \cdot \begin{bmatrix} 0 \\ 0 \\ \vdots \\ 0 \\ 1 \end{bmatrix}$$
            The full implementation can be seen <a href="https://github.com/Camelpilot33/nbonacci/blob/main/main.c" target="_blank">here</a>.

            <br><br><h3>Further generalization</h3>
            For the sequence $F_m = \alpha F_{m-1} + \beta F_{m-2} + \ldots + \gamma F_{m-n}$, the $m$th number is:
            $$F_m = \begin{bmatrix} 0 & 1 & \cdots & 0 \\ \vdots & \vdots & \ddots & \vdots \\ 0 & 0 & \ddots & 1\\ \alpha & \beta & \cdots & \gamma \end{bmatrix}^m_{1n}$$
            Which can be evaluated in $\mathcal O(\log m)$ time and $\mathcal O(1)$ space, using the matrix exponentiation method.
    </div>
    <br><br>
</body>

</html>